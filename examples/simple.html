<!doctype html>
<html>
  <head>
    <meta charset="utf8" />
    <title>Simple Backbone.localForage example</title>
    <script src="../bower_components/jquery/dist/jquery.js"></script>
    <script src="../bower_components/underscore/underscore.js"></script>
    <script src="../bower_components/backbone/backbone.js"></script>
    <script src="../bower_components/localforage/dist/localforage.js"></script>
    <script src="../dist/localforage.backbone.js"></script>
  </head>
  <body>
    <script type="template/form" id="formtpl">
        <form>
            <input type="text" name="content" />
            <input type="submit" value="Create" />
        </form>
        <ul class="list"></ul>
    </script>
    <script type="template/form" id="itemtpl">
        <p><%= content %></p>
    </script>
    <script>
      (function (Backbone, $, _) {
          'use strict';

          // Set driver (optional, but we use localforage here so developers
          // can more easily inspect it).
          localforage.setDriver('localStorageWrapper');

          // We store offline data inside a collection. This is how we tell
          // a model/collection to store data offline with localForage.
          var MyCollection = Backbone.Collection.extend({
              sync: Backbone.localforage.sync('MyCollection'),
              model: Backbone.Model.extend({
                  sync: Backbone.localforage.sync('ModelNamespace')
              })
          });

          // A view with a form and the collection contents
          var MyFormView = Backbone.View.extend({
              events: {
                  'submit form': 'handleSaveModel'
              },

              initialize: function () {
                  // For the sake of the example, this is very bad
                  // performance-wise :)
                  this.listenTo(this.collection, 'add', this.addItemView);
                  this.listenTo(this.collection, 'remove change', this.render);
              },

              addItemView: function (model) {
                  var itemView = new ItemView({model: model});
                  this.$list.append(itemView.render().el);
              },

              handleSaveModel: function (event) {
                  debugger;
                  event.preventDefault();
                  // It'll write on the localforage offline store
                  this.collection.create({content: this.$('[name="content"]').val()});
              },

              render: function () {
                  // Render the form template on this.$el and append the
                  // collection content
                  this.$el.html(_.template($('#formtpl').html()));

                  // cache DOM list container
                  this.$list = $(this.$el.find('.list')[0]);
                  return this;
              }
          });

          var ItemView = Backbone.View.extend({
              tagName: 'li',
              className: 'list--item',
              template: _.template($('#itemtpl').html()),

              render: function () {
                  this.$el.html(this.template({
                      content: this.model.get('content')
                  }));
                  return this;
              }
          });

          // Instancing the collection and the view
          var collectionInstance = new MyCollection();
          var myFormView = new MyFormView({
              el: $('<div>', {'class': 'content'}).appendTo(document.body),
              collection: collectionInstance
          });

          myFormView.render();
          collectionInstance.fetch();
      }(this.Backbone, this.$, this._));
    </script>
  </body>
</html>
